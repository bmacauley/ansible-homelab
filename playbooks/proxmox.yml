---
# Configure Proxmox hosts (assumes Tailscale already installed via bootstrap)
- name: Configure Proxmox hosts
  hosts: proxmox
  gather_facts: true
  become: true

  pre_tasks:
    - name: Ensure Python exists
      ansible.builtin.raw: test -e /usr/bin/python3 || (apt update -y && apt install -y python3)
      changed_when: false
      tags:
        - always

    - name: Gather facts after Python installation
      ansible.builtin.setup:
      tags:
        - always

  roles:
    - role: proxmox
      tags:
        - proxmox
        - ssl
        - iso-builder
        - repos
    - role: dns
      tags:
        - dns
    - role: mdns
      tags:
        - mdns

  post_tasks:
    - name: Validate Proxmox node uptime
      ansible.builtin.command: uptime
      changed_when: false
      register: uptime_output
      tags:
        - validation

    - name: Display uptime
      ansible.builtin.debug:
        msg: "{{ uptime_output.stdout }}"
      tags:
        - validation
