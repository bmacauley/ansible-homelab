---
# Configure storage hosts (assumes Tailscale already installed via bootstrap)
# Note: Assumes passwordless sudo configured during bootstrap
- name: Configure storage hosts
  hosts: storage
  gather_facts: true
  become: true

  pre_tasks:
    - name: Ensure Python exists
      ansible.builtin.raw: test -e /usr/bin/python3 || (apt update -y && apt install -y python3)
      changed_when: false
      tags:
        - always

    - name: Gather facts after Python installation
      ansible.builtin.setup:
      tags:
        - always

    - name: Set system hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname | regex_replace('\\d+$', '') }}"
      tags:
        - hostname

    - name: Update /etc/hosts with hostname
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ inventory_hostname | regex_replace('\\d+$', '') }}"
        state: present
      tags:
        - hostname

  roles:
    - role: mdns
      tags:
        - mdns
    - role: minio
      tags:
        - minio

  post_tasks:
    - name: Validate storage node uptime
      ansible.builtin.command: uptime
      changed_when: false
      register: uptime_output
      tags:
        - validation

    - name: Display uptime
      ansible.builtin.debug:
        msg: "{{ uptime_output.stdout }}"
      tags:
        - validation
