---
- name: Proxmox first boot setup (ansible-pull)
  hosts: localhost
  connection: local
  gather_facts: true
  become: true

  vars:
    # Override tailscale role behavior to skip activation
    tailscale_up_skip: true

  pre_tasks:
    - name: Ensure Python exists
      ansible.builtin.raw: test -e /usr/bin/python3 || (apt update -y && apt install -y python3)
      changed_when: false
      tags:
        - always

    - name: Gather facts after Python installation
      ansible.builtin.setup:
      tags:
        - always

    - name: Display first boot information
      ansible.builtin.debug:
        msg:
          - "Running Proxmox first boot configuration"
          - "Hostname: {{ ansible_hostname }}"
          - "Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "IP Address: {{ ansible_default_ipv4.address | default('N/A') }}"
      tags:
        - always

  tasks:
    - name: Install Tailscale repository key
      ansible.builtin.apt_key:
        url: https://pkgs.tailscale.com/stable/debian/{{ ansible_distribution_release }}.noarmor.gpg
        state: present
        keyring: /usr/share/keyrings/tailscale-archive-keyring.gpg
      tags:
        - tailscale
        - install

    - name: Add Tailscale repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/debian {{ ansible_distribution_release }} main"
        state: present
        filename: tailscale
      tags:
        - tailscale
        - install

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags:
        - tailscale
        - install

    - name: Install Tailscale
      ansible.builtin.apt:
        name: tailscale
        state: present
      tags:
        - tailscale
        - install

    - name: Ensure Tailscale service is enabled but not started
      ansible.builtin.systemd:
        name: tailscaled
        enabled: true
        state: stopped
      tags:
        - tailscale
        - service

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg:
          - "First boot setup completed successfully"
          - "Tailscale has been installed but NOT activated"
          - "To activate Tailscale, run: tailscale up --authkey=YOUR_KEY"
          - "Or run the main proxmox.yml playbook with proper configuration"
      tags:
        - always

    - name: Validate Tailscale installation
      ansible.builtin.command: tailscale version
      changed_when: false
      register: tailscale_version_output
      tags:
        - validation

    - name: Display Tailscale version
      ansible.builtin.debug:
        msg: "{{ tailscale_version_output.stdout }}"
      tags:
        - validation

    - name: Display system uptime
      ansible.builtin.command: uptime
      changed_when: false
      register: uptime_output
      tags:
        - validation

    - name: Show uptime
      ansible.builtin.debug:
        msg: "{{ uptime_output.stdout }}"
      tags:
        - validation
