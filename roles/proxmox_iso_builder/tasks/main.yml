---
# proxmox_iso_builder role tasks

- name: Set system timezone
  ansible.builtin.command: timedatectl set-timezone {{ proxmox_iso_builder_timezone }}
  changed_when: false
  when: proxmox_iso_builder_timezone is defined and proxmox_iso_builder_timezone | length > 0

- name: Check if enterprise repo exists
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/pve-enterprise.list
  register: proxmox_iso_builder_enterprise_repo

- name: Disable Proxmox enterprise repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/pve-enterprise.list
    content: |
      # Disabled - requires subscription
      # deb https://enterprise.proxmox.com/debian/pve {{ proxmox_iso_builder_codename }} pve-enterprise
    owner: root
    group: root
    mode: "0644"
  when:
    - proxmox_iso_builder_disable_enterprise_repo
    - proxmox_iso_builder_enterprise_repo.stat.exists
  notify: Update apt cache

- name: Check if Ceph enterprise repo exists
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/ceph.list
  register: proxmox_iso_builder_ceph_repo

- name: Disable Ceph enterprise repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/ceph.list
    content: |
      # Disabled - requires subscription
      # deb https://enterprise.proxmox.com/debian/ceph-squid {{ proxmox_iso_builder_codename }} enterprise
    owner: root
    group: root
    mode: "0644"
  when:
    - proxmox_iso_builder_disable_enterprise_repo
    - proxmox_iso_builder_ceph_repo.stat.exists
  notify: Update apt cache

- name: Add Proxmox no-subscription repository
  ansible.builtin.apt_repository:
    repo: "deb http://download.proxmox.com/debian/pve {{ proxmox_iso_builder_codename }} pve-no-subscription"
    filename: pve-no-subscription
    state: present
  when: proxmox_iso_builder_enable_no_subscription_repo
  notify: Update apt cache

- name: Flush handlers to update apt cache
  ansible.builtin.meta: flush_handlers

- name: Install ISO building tools
  ansible.builtin.apt:
    name: "{{ proxmox_iso_builder_packages }}"
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Ensure ISO working directory exists
  ansible.builtin.file:
    path: "{{ proxmox_iso_builder_workdir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Verify proxmox-auto-install-assistant is installed
  ansible.builtin.command: proxmox-auto-install-assistant --version
  register: proxmox_iso_builder_version
  changed_when: false
  when: not (proxmox_iso_builder_skip_version_check | default(false))

- name: Display proxmox-auto-install-assistant version
  ansible.builtin.debug:
    msg: "proxmox-auto-install-assistant version: {{ proxmox_iso_builder_version.stdout }}"
  when: not (proxmox_iso_builder_skip_version_check | default(false))
